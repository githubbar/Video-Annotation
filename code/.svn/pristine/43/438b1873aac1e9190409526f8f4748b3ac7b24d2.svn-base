# -*- coding: utf-8 -*-
"""Define button/checkbox/tab event handlers for the main window"""
import logging
from PyQt4.QtGui import *
from PyQt4.QtCore import *
import os, datetime, threading, subprocess, time, sys
from annotateview import *
from projectdialog import ProjectDialog
from heatmap import HeatMap     
from variabledialog import *

class ButtonEvents():
    def tabChanged(self,  index):
        self.actions[0].trigger() # switch to select mode        
        if index == 0: # edit
            self.graphicsView.scene.heatmap.setVisible(False)    
            self.splitterEditTop.insertWidget(0, self.graphicsView)
            self.graphicsView.fitSceneInView()       
            self.graphicsView.scale(0.7, 0.7)
        if index == 1: # search
            self.graphicsView.scene.heatmap.setVisible(True)     
            self.splitterSearch.insertWidget(0, self.graphicsView)
            self.initSearchWidget()        
            self.graphicsView.fitSceneInView()            
        
    def handleToolbarButton(self):
        sender = self.sender()
        if not sender.isChecked():
            sender.toggle()
        for a in self.actions: 
            if a != sender:
                a.setChecked(False)
        self.graphicsView.scene.mode = sender.text()
       

        # Update path visibility based on items list checkboxes
        for n in range(self.items.rowCount()):
            if self.items.item(n, 0).checkState() == Qt.Checked:
                self.items.item(n, 0).g.setVisible(True)
            else:
                self.items.item(n, 0).g.setVisible(False)

        # Select or Path modes: show Paths and disable static figures
        paths = (self.graphicsView.scene.mode == 'Select' or self.graphicsView.scene.mode == 'Path') and (self.tabWidget.currentIndex() == 0)
        snapshot = (self.graphicsView.scene.mode == 'Select' or self.graphicsView.scene.mode == 'Snapshot' or  self.graphicsView.scene.mode == 'Edit')
        for i in self.graphicsView.scene.items():
            if type(i) == Path:
                i.setVisible(i.isVisible() and paths)
            elif type(i) == Snapshot:
                i.setEnabled(snapshot)
                if snapshot: i.setAcceptedMouseButtons(Qt.LeftButton | Qt.RightButton)
                else: i.setAcceptedMouseButtons(Qt.NoButton)
            else:
                i.setEnabled(not paths)
                if paths: i.setAcceptedMouseButtons(Qt.NoButton)
                else: i.setAcceptedMouseButtons(Qt.LeftButton | Qt.RightButton)
        
    def handleFullScreen(self):
        qtMax = 16777215
        if self.fullScreen:
            self.upperPanel.setMaximumHeight(qtMax) 
            self.items.setMaximumWidth(qtMax) 
            self.checkAll.setMaximumWidth(qtMax) 
        else:
            self.upperPanel.setMaximumHeight(0)
            self.items.setMaximumWidth(0) 
            self.checkAll.setMaximumWidth(0) 
        self.fullScreen = not self.fullScreen
        
    def playClicked(self):
        if self.mediaPlayer.is_playing():
            self.mediaPlayer.pause()
            self.playButton.setIcon(QIcon('icons/player_play.png'))
            self.isPaused = True
        elif self.mediaPlayer.play() != -1:            
            self.playButton.setIcon(QIcon('icons/player_pause.png'))
            self.timer.start()
            self.isPaused = False        

    def showProjectProperties(self):
        projectDialog = ProjectDialog(self)
        projectDialog.spinnerW.setValue(self.graphicsView.scene.width())
        projectDialog.spinnerH.setValue(self.graphicsView.scene.height())
        projectDialog.categoryFileEdit.setText(self.graphicsView.scene.categoriesPath)
        projectDialog.backgroundFileEdit.setText(self.graphicsView.scene.backgroundPath)
        projectDialog.pathSmoothingSlider.setValue(int(self.graphicsView.scene.pathSmoothingFactor*100))
#        projectDialog.setModal(True)
        if projectDialog.exec_() == QDialog.Accepted:
            self.graphicsView.scene.setSceneRect(0, 0, projectDialog.spinnerW.value(),  projectDialog.spinnerH.value())
            self.graphicsView.scene.categoriesPath = str(projectDialog.categoryFileEdit.text())
            self.graphicsView.scene.backgroundPath = str(projectDialog.backgroundFileEdit.text())
            self.graphicsView.scene.pathSmoothingFactor = 0.01*projectDialog.pathSmoothingSlider.value()
            # update scene properties to reflect the new settings
            self.graphicsView.scene.updateProjectProperties()

    def variablesClicked(self):
        dlg = VariableDialog(self)      
        if dlg.exec_() == QDialog.Accepted:
            dlg.saveVariables()
        print self.graphicsView.scene.variables
